import axios from 'axios';
import { Message, ThreadChannel } from 'discord.js';
import * as dotenv from 'dotenv';

dotenv.config();

interface GitHubConfig {
    enabled: boolean;
}

interface GitHubIssue {
    number: number;
    title: string;
    body: string;
    state: 'open' | 'closed';
    html_url: string;
}

interface GitHubComment {
    id: number;
    body: string;
    html_url: string;
}

export class GitHubSyncService {
    private config: GitHubConfig;
    private baseUrl = 'https://api.github.com';
    private issueMap: Map<string, number> = new Map(); // threadId -> issueNumber
    private commentMap: Map<string, number> = new Map(); // messageId -> commentId
    private token: string;
    private repository: string;
    private currentUser: string | null = null;
    private webhookCallback: ((issueNumber: number, threadId: string) => void) | null = null;

    constructor(config: GitHubConfig) {
        this.config = config;
        this.token = process.env.GITHUB_TOKEN || '';
        this.repository = process.env.GITHUB_REPOSITORY || '';
        
        if (config.enabled && (!this.token || !this.repository)) {
            console.warn('âš ï¸ GitHub ë™ê¸°í™”ê°€ í™œì„±í™”ë˜ì—ˆì§€ë§Œ GITHUB_TOKEN ë˜ëŠ” GITHUB_REPOSITORY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            this.config.enabled = false;
        }
    }

    public setEnabled(enabled: boolean) {
        this.config.enabled = enabled;
    }

    public setWebhookCallback(callback: (issueNumber: number, threadId: string) => void) {
        this.webhookCallback = callback;
    }

    private getHeaders() {
        return {
            'Authorization': `token ${this.token}`,
            'Accept': 'application/vnd.github.v3+json',
            'User-Agent': 'Discord-Forum-Bot'
        };
    }

    public async deleteCommentForMessage(messageId: string): Promise<boolean> {
        if (!this.config.enabled) {
            console.log('ğŸ“¤ GitHub ë™ê¸°í™”ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            return false;
        }

        try {
            const commentId = this.commentMap.get(messageId);
            
            if (!commentId) {
                console.log(`âš ï¸ ë©”ì‹œì§€ ${messageId}ì— í•´ë‹¹í•˜ëŠ” GitHub ëŒ“ê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return false;
            }

            console.log(`ğŸ™ [GITHUB DEBUG] ëŒ“ê¸€ ì‚­ì œ ì‹œë„: ëŒ“ê¸€ ID ${commentId}`);

            const response = await axios.delete(
                `${this.baseUrl}/repos/${this.repository}/issues/comments/${commentId}`,
                { headers: this.getHeaders() }
            );

            if (response.status === 204) {
                // ì„±ê³µì ìœ¼ë¡œ ì‚­ì œëœ ê²½ìš° ë§¤í•‘ì—ì„œ ì œê±°
                this.commentMap.delete(messageId);
                console.log(`âœ… [GITHUB DEBUG] ëŒ“ê¸€ ì‚­ì œ ì„±ê³µ ë° ë§¤í•‘ ì œê±°: ë©”ì‹œì§€ ${messageId} -> ëŒ“ê¸€ ${commentId}`);
                return true;
            } else {
                console.error(`âŒ [GITHUB DEBUG] ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨: HTTP ${response.status}`);
                return false;
            }
        } catch (error: any) {
            if (error.response?.status === 404) {
                // ëŒ“ê¸€ì´ ì´ë¯¸ ì‚­ì œëœ ê²½ìš° ë§¤í•‘ì—ì„œ ì œê±°
                this.commentMap.delete(messageId);
                console.log(`âš ï¸ [GITHUB DEBUG] ëŒ“ê¸€ì´ ì´ë¯¸ ì‚­ì œë¨: ë§¤í•‘ ì œê±° ${messageId}`);
                return true;
            }
            console.error('âŒ [GITHUB DEBUG] ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error.response?.data || error.message);
            return false;
        }
    }

    public async createIssueForNewPost(message: Message, forumChannelName: string): Promise<string | null> {
        if (!this.config.enabled) {
            console.log('ğŸ“¤ GitHub ë™ê¸°í™”ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            return null;
        }

        try {
            if (!message.guild || !message.channel) {
                console.log('âŒ ê¸¸ë“œ ë˜ëŠ” ì±„ë„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return null;
            }

            const thread = message.channel as ThreadChannel;
            const postLink = `https://discord.com/channels/${message.guild.id}/${thread.id}`;
            
            // Issue ì œëª©ê³¼ ë³¸ë¬¸ êµ¬ì„±
            const title = `${thread.name}`;
            const body = `**${message.author.displayName || message.author.username}**
${message.content}

---
**Discord Forum:** ${forumChannelName}
**Source:** ${postLink}
**Thread ID:** ${thread.id}
*This issue is automatically synchronized with a corresponding thread in Discord.*`;

            // GitHub Issue ìƒì„±
            const response = await axios.post(
                `${this.baseUrl}/repos/${this.repository}/issues`,
                {
                    title,
                    body,
                    labels: ['discord-forum', 'new-post', forumChannelName.toLowerCase()]
                },
                { headers: this.getHeaders() }
            );

            const issue: GitHubIssue = response.data;
            
            // ìŠ¤ë ˆë“œ IDì™€ ì´ìŠˆ ë²ˆí˜¸ ë§¤í•‘ ì €ì¥
            this.issueMap.set(thread.id, issue.number);
            
            // ì›¹í›… ì„œë¹„ìŠ¤ì— ë§¤í•‘ ì •ë³´ ì „ë‹¬
            if (this.webhookCallback) {
                this.webhookCallback(issue.number, thread.id);
            }
            
            console.log(`âœ… GitHub ì´ìŠˆ ìƒì„± ì™„ë£Œ: #${issue.number} - ${issue.html_url}`);
            return issue.html_url;

        } catch (error: any) {
            console.error('âŒ GitHub ì´ìŠˆ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error.response?.data || error.message);
            return null;
        }
    }

    public async addCommentForNewMessage(message: Message, forumChannelName: string): Promise<string | null> {
        if (!this.config.enabled) {
            console.log('ğŸ“¤ GitHub ë™ê¸°í™”ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            return null;
        }

        try {
            if (!message.guild || !message.channel) {
                console.log('âŒ ê¸¸ë“œ ë˜ëŠ” ì±„ë„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return null;
            }

            const thread = message.channel as ThreadChannel;
            let issueNumber = this.issueMap.get(thread.id);
            
            // ë©”ëª¨ë¦¬ì— ì´ìŠˆ ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ GitHubì—ì„œ ê²€ìƒ‰
            if (!issueNumber) {
                console.log(`ğŸ” ìŠ¤ë ˆë“œ ${thread.id}ì— í•´ë‹¹í•˜ëŠ” GitHub ì´ìŠˆë¥¼ ê²€ìƒ‰ ì¤‘...`);
                issueNumber = await this.findExistingIssue(thread.id, thread.name) ?? undefined;
                
                if (!issueNumber) {
                    console.log(`âŒ ìŠ¤ë ˆë“œ "${thread.name}"ì— í•´ë‹¹í•˜ëŠ” GitHub ì´ìŠˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                    return null;
                }
                
                // ì°¾ì€ ì´ìŠˆë¥¼ ë©”ëª¨ë¦¬ì— ì €ì¥
                this.issueMap.set(thread.id, issueNumber);
                console.log(`âœ… ê¸°ì¡´ GitHub ì´ìŠˆ ì°¾ìŒ: #${issueNumber}`);
            }

            const messageLink = `https://discord.com/channels/${message.guild.id}/${thread.id}/${message.id}`;
            
            // ëŒ“ê¸€ ë³¸ë¬¸ êµ¬ì„±
            const commentBody = `**${message.author.displayName || message.author.username}**
${message.content}

---
**Discord Forum:** ${forumChannelName}
**Source:** ${messageLink}
* This issue is automatically synchronized with a corresponding thread in Discord.*`;

            // GitHub Comment ìƒì„±
            const response = await axios.post(
                `${this.baseUrl}/repos/${this.repository}/issues/${issueNumber}/comments`,
                { body: commentBody },
                { headers: this.getHeaders() }
            );

            const comment: GitHubComment = response.data;
            
            // ë©”ì‹œì§€ IDì™€ ëŒ“ê¸€ ID ë§¤í•‘ ì €ì¥
            this.commentMap.set(message.id, comment.id);
            console.log(`ğŸ“ [GITHUB DEBUG] ëŒ“ê¸€ ë§¤í•‘ ì €ì¥: ë©”ì‹œì§€ ${message.id} -> ëŒ“ê¸€ ${comment.id}`);
            
            console.log(`âœ… GitHub ëŒ“ê¸€ ì¶”ê°€ ì™„ë£Œ: ${comment.html_url}`);
            return comment.html_url;

        } catch (error: any) {
            console.error('âŒ GitHub ëŒ“ê¸€ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:', error.response?.data || error.message);
            return null;
        }
    }

    public async closeIssueForClosedPost(threadId: string, reason?: string): Promise<boolean> {
        if (!this.config.enabled) {
            console.log('ğŸ“¤ GitHub ë™ê¸°í™”ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
            return false;
        }

        try {
            let issueNumber = this.issueMap.get(threadId);
            
            if (!issueNumber) {
                console.log(`âŒ ìŠ¤ë ˆë“œ ${threadId}ì— í•´ë‹¹í•˜ëŠ” GitHub ì´ìŠˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì¢…ë£Œ ì‹œì—ëŠ” ê²€ìƒ‰í•˜ì§€ ì•ŠìŒ)`);
                return false;
            }

            // ë§ˆì§€ë§‰ ëŒ“ê¸€ë¡œ ì¢…ë£Œ ì‚¬ìœ  ì¶”ê°€
            if (reason) {
                const closeCommentBody = `**The linked forum post has been closed.**

Reason for closure: ${reason}
Closed on: ${new Date().toLocaleString('en-US')}

---
* This issue is automatically synchronized with a corresponding thread in Discord.*`;

                await axios.post(
                    `${this.baseUrl}/repos/${this.repository}/issues/${issueNumber}/comments`,
                    { body: closeCommentBody },
                    { headers: this.getHeaders() }
                );
            }

            // GitHub Issue ì¢…ë£Œ
            await axios.patch(
                `${this.baseUrl}/repos/${this.repository}/issues/${issueNumber}`,
                { state: 'closed' },
                { headers: this.getHeaders() }
            );

            // ë§¤í•‘ì—ì„œ ì œê±°
            this.issueMap.delete(threadId);
            
            console.log(`âœ… GitHub ì´ìŠˆ ì¢…ë£Œ ì™„ë£Œ: #${issueNumber}`);
            return true;

        } catch (error: any) {
            console.error('âŒ GitHub ì´ìŠˆ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜:', error.response?.data || error.message);
            return false;
        }
    }

    public async handleReaction(messageId: string, threadId: string, emoji: string, userId: string, userName: string, added: boolean, threadName?: string): Promise<boolean> {
        console.log(`ğŸ” [GITHUB DEBUG] handleReaction í˜¸ì¶œ: emoji=${emoji}, user=${userName}, added=${added}`);
        
        if (!this.config.enabled) {
            console.log(`âŒ [GITHUB DEBUG] GitHub ë™ê¸°í™” ë¹„í™œì„±í™”ë¨`);
            return false;
        }

        try {
            let issueNumber = this.issueMap.get(threadId);
            console.log(`ğŸ” [GITHUB DEBUG] ìŠ¤ë ˆë“œ ${threadId}ì˜ ì´ìŠˆ ë²ˆí˜¸: ${issueNumber}`);
            
            // ë©”ëª¨ë¦¬ì— ì´ìŠˆ ë²ˆí˜¸ê°€ ì—†ìœ¼ë©´ GitHubì—ì„œ ê²€ìƒ‰
            if (!issueNumber && threadName) {
                console.log(`ğŸ” [GITHUB DEBUG] ë©”ëª¨ë¦¬ì— ì´ìŠˆ ì—†ìŒ. GitHubì—ì„œ ê²€ìƒ‰ ì‹œë„: "${threadName}"`);
                issueNumber = await this.findExistingIssue(threadId, threadName) ?? undefined;
                
                if (issueNumber) {
                    console.log(`âœ… [GITHUB DEBUG] GitHubì—ì„œ ì´ìŠˆ ì°¾ìŒ: #${issueNumber}`);
                    this.issueMap.set(threadId, issueNumber);
                } else {
                    console.log(`âŒ [GITHUB DEBUG] GitHubì—ì„œ ì´ìŠˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: "${threadName}"`);
                    return false;
                }
            } else if (!issueNumber) {
                console.log(`âŒ [GITHUB DEBUG] ì´ìŠˆ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ. ìŠ¤ë ˆë“œ ID: ${threadId}, ì´ë¦„: ${threadName || 'N/A'}`);
                return false;
            }

            // Discord ì´ëª¨ì§€ë¥¼ GitHub ë°˜ì‘ìœ¼ë¡œ ë§¤í•‘
            const githubReaction = this.mapDiscordEmojiToGitHub(emoji);
            console.log(`ğŸ” [GITHUB DEBUG] ì´ëª¨ì§€ ë§¤í•‘: ${emoji} -> ${githubReaction}`);
            
            if (!githubReaction) {
                console.log(`âš ï¸ [GITHUB DEBUG] ì§€ì›ë˜ì§€ ì•ŠëŠ” ì´ëª¨ì§€: ${emoji}`);
                return false;
            }

            // ë©”ì‹œì§€ IDë¡œ ëŒ“ê¸€ ID í™•ì¸
            const commentId = this.commentMap.get(messageId);
            let targetUrl: string;
            let targetType: string;

            console.log(`ğŸ” [GITHUB DEBUG] í˜„ì¬ ëŒ“ê¸€ ë§¤í•‘ ìƒíƒœ:`);
            console.log(`ğŸ” [GITHUB DEBUG] - ì°¾ëŠ” ë©”ì‹œì§€ ID: ${messageId}`);
            console.log(`ğŸ” [GITHUB DEBUG] - ë§¤í•‘ëœ ëŒ“ê¸€ ID: ${commentId || 'None'}`);
            console.log(`ğŸ” [GITHUB DEBUG] - ì „ì²´ ëŒ“ê¸€ ë§¤í•‘ ìˆ˜: ${this.commentMap.size}`);
            
            // ë””ë²„ê¹…ì„ ìœ„í•´ ëŒ“ê¸€ ë§¤í•‘ ì „ì²´ ì¶œë ¥ (ìµœëŒ€ 5ê°œ)
            const mappingEntries = Array.from(this.commentMap.entries()).slice(0, 5);
            mappingEntries.forEach(([msgId, cmtId]) => {
                console.log(`ğŸ” [GITHUB DEBUG] - ë§¤í•‘: ${msgId} -> ${cmtId}`);
            });

            if (commentId) {
                // ëŒ“ê¸€ì— ë°˜ì‘ ì¶”ê°€
                targetUrl = `${this.baseUrl}/repos/${this.repository}/issues/comments/${commentId}/reactions`;
                targetType = `ëŒ“ê¸€ #${commentId}`;
                console.log(`ğŸ¯ [GITHUB DEBUG] ëŒ“ê¸€ ë°˜ì‘ ëŒ€ìƒ: ë©”ì‹œì§€ ${messageId} -> ëŒ“ê¸€ ${commentId}`);
            } else {
                // ì´ìŠˆì— ë°˜ì‘ ì¶”ê°€ (ì²« ë²ˆì§¸ ë©”ì‹œì§€)
                targetUrl = `${this.baseUrl}/repos/${this.repository}/issues/${issueNumber}/reactions`;
                targetType = `ì´ìŠˆ #${issueNumber}`;
                console.log(`ğŸ¯ [GITHUB DEBUG] ì´ìŠˆ ë°˜ì‘ ëŒ€ìƒ: ì²« ë²ˆì§¸ ë©”ì‹œì§€ -> ì´ìŠˆ ${issueNumber}`);
                console.log(`âš ï¸ [GITHUB DEBUG] ëŒ“ê¸€ ë§¤í•‘ì´ ì—†ëŠ” ì´ìœ : ì²« ë²ˆì§¸ ë©”ì‹œì§€ì´ê±°ë‚˜ ë§¤í•‘ì´ ì†ì‹¤ë¨`);
            }

            if (added) {
                // ë°˜ì‘ ì¶”ê°€
                console.log(`ğŸ” [GITHUB DEBUG] GitHub ë°˜ì‘ ì¶”ê°€ ì‹œë„: ${githubReaction} to ${targetType}`);
                const addResponse = await axios.post(
                    targetUrl,
                    { content: githubReaction },
                    { 
                        headers: {
                            ...this.getHeaders(),
                            'Accept': 'application/vnd.github.squirrel-girl-preview+json'
                        }
                    }
                );
                console.log(`âœ… [GITHUB DEBUG] GitHub ë°˜ì‘ ì¶”ê°€ ì™„ë£Œ: ${githubReaction} to ${targetType}, ì‘ë‹µ:`, addResponse.status);
            } else {
                // ë°˜ì‘ ì œê±° - í˜„ì¬ ì‚¬ìš©ìì˜ ë°˜ì‘ì„ ì°¾ì•„ì„œ ì œê±°
                console.log(`ğŸ” [GITHUB DEBUG] GitHub ë°˜ì‘ ì œê±° ì‹œë„: ${githubReaction} from issue #${issueNumber}`);
                try {
                    // ì´ìŠˆì˜ ëª¨ë“  ë°˜ì‘ ì¡°íšŒ
                    const reactionsResponse = await axios.get(
                        `${this.baseUrl}/repos/${this.repository}/issues/${issueNumber}/reactions`,
                        { 
                            headers: {
                                ...this.getHeaders(),
                                'Accept': 'application/vnd.github.squirrel-girl-preview+json'
                            }
                        }
                    );

                    console.log(`ğŸ” [GITHUB DEBUG] ê¸°ì¡´ ë°˜ì‘ ê°œìˆ˜: ${reactionsResponse.data.length}`);

                    // í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ìì˜ í•´ë‹¹ ë°˜ì‘ ì°¾ê¸°
                    const currentUser = await this.getCurrentUser();
                    console.log(`ğŸ” [GITHUB DEBUG] í˜„ì¬ ì‚¬ìš©ì: ${currentUser}`);
                    
                    const userReaction = reactionsResponse.data.find((reaction: any) => 
                        reaction.content === githubReaction && reaction.user.login === currentUser
                    );

                    if (userReaction) {
                        console.log(`ğŸ” [GITHUB DEBUG] ì œê±°í•  ë°˜ì‘ ì°¾ìŒ: ID ${userReaction.id}`);
                        // ë°˜ì‘ ì œê±°
                        await axios.delete(
                            `${this.baseUrl}/repos/${this.repository}/issues/${issueNumber}/reactions/${userReaction.id}`,
                            { 
                                headers: {
                                    ...this.getHeaders(),
                                    'Accept': 'application/vnd.github.squirrel-girl-preview+json'
                                }
                            }
                        );
                        console.log(`âœ… [GITHUB DEBUG] GitHub ë°˜ì‘ ì œê±° ì™„ë£Œ: ${githubReaction}`);
                    } else {
                        console.log(`â„¹ï¸ [GITHUB DEBUG] ì œê±°í•  ë°˜ì‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${githubReaction} by ${currentUser}`);
                    }
                } catch (removeError: any) {
                    console.error('âŒ [GITHUB DEBUG] GitHub ë°˜ì‘ ì œê±° ì¤‘ ì˜¤ë¥˜:', removeError.response?.data || removeError.message);
                }
            }

            console.log(`âœ… [GITHUB DEBUG] handleReaction ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ`);
            return true;

        } catch (error: any) {
            console.error('âŒ [GITHUB DEBUG] GitHub ë°˜ì‘ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜:', error.response?.data || error.message);
            return false;
        }
    }

    private mapDiscordEmojiToGitHub(discordEmoji: string): string | null {
        // Discord ì´ëª¨ì§€ë¥¼ GitHub ë°˜ì‘ìœ¼ë¡œ ë§¤í•‘
        const emojiMap: { [key: string]: string } = {
            // ê¸°ë³¸ ì´ëª¨ì§€ë“¤
            'ğŸ‘': '+1',
            'ğŸ‘': '-1',
            'ğŸ˜„': 'laugh',
            'ğŸ‰': 'hooray',
            'ğŸ˜•': 'confused',
            'â¤ï¸': 'heart',
            'ğŸš€': 'rocket',
            'ğŸ‘€': 'eyes',
            
            // ë‹¤ë¥¸ í˜•íƒœë“¤ë„ ì§€ì›
            'ğŸ˜‚': 'laugh',
            'ğŸ˜': 'heart',
            'ğŸ”¥': 'rocket',
            'ğŸ’¯': 'hooray',
            'ğŸ˜­': 'confused',
            'ğŸ‘': 'hooray',
            'âœ…': '+1',
            'âŒ': '-1',
            'ğŸ’–': 'heart',
            'ğŸ’œ': 'heart',
            'ğŸ’™': 'heart',
            'ğŸ’š': 'heart',
            'ğŸ’›': 'heart',
            'ğŸ§¡': 'heart'
        };

        return emojiMap[discordEmoji] || null;
    }

    private async getCurrentUser(): Promise<string> {
        if (!this.currentUser) {
            try {
                const response = await axios.get(`${this.baseUrl}/user`, {
                    headers: this.getHeaders()
                });
                this.currentUser = response.data.login;
            } catch (error) {
                console.error('âŒ GitHub ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                return '';
            }
        }
        return this.currentUser || '';
    }

    public async findExistingIssue(threadId: string, threadTitle: string): Promise<number | null> {
        try {
            // 1. ì •í™•í•œ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰
            let searchQuery = `repo:${this.repository} is:issue in:title "${threadTitle}"`;
            let response = await axios.get(
                `${this.baseUrl}/search/issues?q=${encodeURIComponent(searchQuery)}`,
                { headers: this.getHeaders() }
            );

            let issues = response.data.items;
            
            // ì •í™•í•œ ë§¤ì¹˜ ì°¾ê¸°
            let exactMatch = issues.find((issue: any) => issue.title === threadTitle);
            if (exactMatch) {
                const issueNumber = exactMatch.number;
                this.issueMap.set(threadId, issueNumber);
                console.log(`âœ… ì •í™•í•œ ì œëª©ìœ¼ë¡œ GitHub ì´ìŠˆ ì°¾ìŒ: #${issueNumber} - "${threadTitle}"`);
                return issueNumber;
            }

            // 2. ë ˆì´ë¸”ë¡œ ê²€ìƒ‰ (discord-forum ë ˆì´ë¸”ì´ ìˆëŠ” ì´ìŠˆë“¤)
            searchQuery = `repo:${this.repository} is:issue label:discord-forum`;
            response = await axios.get(
                `${this.baseUrl}/search/issues?q=${encodeURIComponent(searchQuery)}`,
                { headers: this.getHeaders() }
            );

            issues = response.data.items;
            
            // Discord ìŠ¤ë ˆë“œ IDê°€ ë³¸ë¬¸ì— í¬í•¨ëœ ì´ìŠˆ ì°¾ê¸°
            const issueWithThreadId = issues.find((issue: any) => 
                issue.body && issue.body.includes(threadId)
            );
            
            if (issueWithThreadId) {
                const issueNumber = issueWithThreadId.number;
                this.issueMap.set(threadId, issueNumber);
                console.log(`âœ… ìŠ¤ë ˆë“œ IDë¡œ GitHub ì´ìŠˆ ì°¾ìŒ: #${issueNumber} - "${issueWithThreadId.title}"`);
                return issueNumber;
            }

            // 3. ë¶€ë¶„ ì œëª© ë§¤ì¹˜
            const partialMatch = issues.find((issue: any) => 
                issue.title.includes(threadTitle) || threadTitle.includes(issue.title)
            );
            
            if (partialMatch) {
                const issueNumber = partialMatch.number;
                this.issueMap.set(threadId, issueNumber);
                console.log(`âœ… ë¶€ë¶„ ë§¤ì¹˜ë¡œ GitHub ì´ìŠˆ ì°¾ìŒ: #${issueNumber} - "${partialMatch.title}"`);
                return issueNumber;
            }

            console.log(`ğŸ” GitHubì—ì„œ "${threadTitle}" ì´ìŠˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
            return null;

        } catch (error: any) {
            console.error('âŒ GitHub ì´ìŠˆ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜:', error.response?.data || error.message);
            return null;
        }
    }

    public async testConnection(): Promise<boolean> {
        try {
            const response = await axios.get(
                `${this.baseUrl}/repos/${this.repository}`,
                { headers: this.getHeaders() }
            );

            console.log(`âœ… GitHub ì €ì¥ì†Œ ì—°ê²° ì„±ê³µ: ${response.data.full_name}`);
            return true;

        } catch (error: any) {
            console.error('âŒ GitHub ì—°ê²° ì‹¤íŒ¨:', error.response?.data || error.message);
            return false;
        }
    }

    public getIssueNumber(threadId: string): number | undefined {
        return this.issueMap.get(threadId);
    }

    public setIssueMapping(threadId: string, issueNumber: number): void {
        this.issueMap.set(threadId, issueNumber);
    }

    public getConfig(): GitHubConfig {
        return this.config;
    }
}